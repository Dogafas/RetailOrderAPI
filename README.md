# Backend-сервис для автоматизации закупок "RetailOrderAPI"

## Описание сервиса

Сервис `RetailOrderAPI` представляет собой backend-платформу для автоматизации заказов товаров из каталога, агрегирующего предложения от нескольких поставщиков. Взаимодействие с сервисом происходит исключительно через REST API.

Клиенты могут просматривать единый каталог товаров, формировать корзину из предложений разных поставщиков и оформлять заказы. Поставщики, в свою очередь, могут управлять своими товарными предложениями и статусом приема заказов через API.

Система спроектирована с упором на асинхронность для обработки ресурсоемких задач (импорт, экспорт, отправка email) без задержек для пользователя.

## Основные возможности

- **Управление пользователями**: Регистрация с подтверждением по email, JWT-аутентификация для клиентов и поставщиков.
- **API для Поставщиков**:
    - Асинхронная загрузка прайс-листов в формате YAML.
    - Управление статусом "активен/неактивен" для приема заказов.
- **API для Клиентов**:
    - Просмотр каталога товаров с пагинацией, фильтрацией и поиском.
    - Управление корзиной (добавление, изменение, удаление товаров).
    - Управление контактными данными (адресами доставки).
    - Оформление заказа.
    - Просмотр истории своих заказов.
- **Асинхронные уведомления**: Отправка email-уведомлений (о создании заказа, смене статуса) через Celery.
- **Экспорт**: Асинхронный экспорт каталога товаров в JSON.
- **Администрирование**: Удобная панель Django Admin для управления заказами и их статусами.
- **Документация**: Автоматически генерируемая интерактивная документация API (Swagger/ReDoc).

## Стек технологий

- **Backend**: Python, Django, Django REST Framework
- **База данных**: PostgreSQL
- **Асинхронные задачи**: Celery
- **Брокер сообщений**: RabbitMQ
- **Кэш / Хранилище результатов Celery**: Redis
- **Контейнеризация**: Docker, Docker Compose
- **Аутентификация**: JWT (djangorestframework-simplejwt)
- **Документация**: drf-spectacular

## Архитектура и основные сущности

### 1. Пользователь (`User`)
Центральная модель для аутентификации. Имеет поле `user_type`, которое разделяет пользователей на **Клиентов** и **Поставщиков**. Регистрация требует подтверждения по email.

### 2. Поставщик (`Supplier`)
Сущность, представляющая магазин. Связана с `User`. Поставщик:
- Имеет название.
- Может управлять своим статусом (`is_active`), определяя, принимает ли он заказы.
- Загружает свой прайс-лист, на основе которого формируются его товарные предложения.

### 3. Категория (`Category`)
Глобальный справочник категорий товаров. Не привязан напрямую к поставщикам.

### 4. Товар (`Product`) и Информация о товаре (`ProductInfo`)
Эта пара моделей реализует логику "один товар - несколько предложений".
- **`Product`**: Абстрактный товар (например, "Смартфон Apple iPhone 15 Pro"). Содержит только название и ссылку на категорию.
- **`ProductInfo`**: Конкретное предложение этого товара от **конкретного поставщика**. Содержит цену, количество на складе, уникальные параметры (цвет, память) и ссылку на `Product` и `Supplier`. Именно `ProductInfo` добавляется в корзину.

### 5. Заказ (`Order`)
Заказ, созданный клиентом. Содержит:
- Ссылку на клиента (`Client`) и его контактные данные (`Contact`).
- Текущий статус (`Новый`, `В обработке` и т.д.).
- Список заказанных позиций (`OrderItem`), которые хранят информацию о товаре и цене на момент покупки.

### 6. Контакт (`Contact`)
Многоразовая сущность, хранящая адрес доставки и контактные данные получателя. Каждый клиент может иметь несколько таких контактов и выбирать один из них при оформлении заказа.

## Порядок взаимодействия с API

#### Поставщик:
1.  **Регистрация**: `POST /api/v1/auth/users/` с `user_type: "supplier"`.
2.  **Аутентификация**: `POST /api/v1/auth/jwt/create/` для получения JWT.
3.  **Загрузка прайс-листа**: `POST /api/v1/supplier/pricelist/` (form-data с файлом) для обновления своих товаров.
4.  **Управление статусом**: `GET/PATCH /api/v1/supplier/status/` для включения/отключения приема заказов.

#### Клиент:
1.  **Регистрация и активация**: `POST /api/v1/auth/users/` с `user_type: "client"`, затем активация по ссылке из email.
2.  **Аутентификация**: `POST /api/v1/auth/jwt/create/` для получения JWT.
3.  **Просмотр каталога**: `GET /api/v1/products/` с возможностью фильтрации (`?category=...`) и поиска (`?search=...`).
4.  **Добавление в корзину**: `POST /api/v1/cart/`, передавая `id` конкретного товарного предложения (`ProductInfo`).
5.  **Управление контактами**: `POST /api/v1/contacts/` для добавления адреса доставки.
6.  **Оформление заказа**: `POST /api/v1/order/`, передавая `id` контакта.
7.  **Просмотр истории**: `GET /api/v1/orders/` для просмотра своих заказов.

## Инструменты для тестирования
Для удобства тестирования и взаимодействия с API подготовлена публичная коллекция запросов в Postman. Она включает в себя все основные эндпоинты, а также настроенные окружения для автоматической подстановки токенов и ID.

[Открыть коллекцию Postman](https://bold-astronaut-977939-2110.postman.co/workspace/%D1%82%D0%B5%D1%81%D1%82%D0%BE%D0%B2%D0%B0%D1%8F-%D0%BA%D0%BE%D0%BC%D0%B0%D0%BD%D0%B4%D0%B0-Workspace~1c03f5ee-9ced-48e9-8fd8-011c1a93ffca/collection/42519970-0cf2a09a-0f96-467c-913d-00043548b465?action=share&creator=42519970&active-environment=42519970-fe124ac2-8293-415c-b26e-a316967da8f4)

Рекомендуется импортировать коллекцию в свое приложение Postman для полноценной работы. 

## Документация API

Интерактивная документация API доступна после запуска проекта по следующим адресам:
- **Swagger UI**: `http://127.0.0.1:8000/api/v1/schema/swagger-ui/`
- **ReDoc**: `http://127.0.0.1:8000/api/v1/schema/redoc/`

## Запуск проекта

1.  Клонируйте репозиторий: `git clone <URL_репозитория>`
2.  Перейдите в папку проекта: `cd RetailOrderAPI`
3.  Создайте файл с переменными окружения `.env` на основе примера `.env.example`.
4.  Выполните сборку и запуск контейнеров:
    ```bash
    docker compose up --build -d
    ```
5.  Примените миграции базы данных:
    ```bash
    docker compose exec backend python manage.py migrate
    ```
6.  Создайте суперпользователя для доступа к админ-панели:
    ```bash
    docker compose exec backend python manage.py createsuperuser
    ```
Сервис будет доступен по адресу `http://127.0.0.1:8000/`.

---

